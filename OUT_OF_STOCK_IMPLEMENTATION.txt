======================================================================
LUỒNG XỬ LÝ OUT-OF-STOCK / UNAVAILABLE ITEMS
======================================================================

BÀI TOÁN:
Khi bếp báo hết món (is_available = false):
- Màn hình OrderConfirmationScreen hiện trạng thái "hết món" ✓

Khi bếp báo còn lại (is_available = true):
- Cần phân biệt giữa "còn nhưng chưa được add lại" vs "có thể order bình thường"
- Những item chưa được add lại vẫn nên hiển thị ở danh mục "Không khả dụng"
- Chỉ khi nhân viên add lại item từ menu mới reset trạng thái này

GIẢI PHÁP:
Sử dụng bảng `order_item_out_of_stock_events` để theo dõi từng order-item:

1. BẢN GHI THỜI ĐIỂM HẾT
   - Khi menu_item.is_available = false, trigger tự động tạo event
   - Ghi nhận marked_out_of_stock_at (lúc báo hết)
   
2. BẢN GHI THỜI ĐIỂM CÒN LẠI
   - Khi menu_item.is_available = true, trigger tự động cập nhật event
   - Ghi nhận remarked_available_at (lúc báo còn)
   - Nhưng chưa mark là "reordered"
   
3. NHÂN VIÊN ADD LẠI ITEM
   - Khi add item từ menu (sendNewItemsToKitchen), app gọi markItemAsReordered()
   - Đánh dấu is_reordered_after_recovery = true
   - Item này không còn ở danh mục "Không khả dụng"

======================================================================
CÁC FILE ĐÃ THAY ĐỔI
======================================================================

1. MIGRATION_OUT_OF_STOCK_TRACKING.sql
   - Tạo bảng order_item_out_of_stock_events
   - Tạo view order_item_unavailable_status
   - Tạo functions: mark_order_items_as_out_of_stock, mark_item_as_reordered
   - Tạo trigger khi menu_items.is_available thay đổi

   Thực thi:
   - Copy nội dung file vào Supabase SQL Editor
   - Chạy toàn bộ script

2. services/outOfStockService.ts [MỚI]
   - getUnavailableItemsForOrder(): Lấy danh sách items "unavailable" cho order
   - markItemAsReordered(): Đánh dấu item đã được add lại
   - subscribeToOutOfStockEvents(): Lắng nghe real-time changes

3. screens/Menu/OrderConfirmationScreen.tsx
   - Thêm state: unavailableOrderItems (Set<number>)
   - Thêm ref: outOfStockSubscriptionRef
   
   - Thêm hàm: loadUnavailableItems()
     • Fetch danh sách unavailable items từ database
     • Update state unavailableOrderItems
   
   - Thêm hàm: subscribeToOutOfStock()
     • Lắng nghe real-time out-of-stock events
     • Tự động reload unavailable items khi có event mới
   
   - Thêm effect: Khi activeOrderId thay đổi
     • Load unavailable items
     • Subscribe to out-of-stock events
   
   - Thêm effect: Khi unavailableOrderItems thay đổi
     • Trigger fetchAllData() để re-render UI
   
   - Sửa logic phân loại items:
     • Thay thế previouslyUnavailableItemsRef bằng unavailableOrderItems state
     • Sử dụng isOrderItemUnavailableState() để check trạng thái
   
   - Sửa sendNewItemsToKitchen():
     • Khi insert items thành công, kiểm tra nếu menu_item_id là unavailable
     • Gọi markItemAsReordered() cho những item đó

======================================================================
LUỒNG HOẠT ĐỘNG CHI TIẾT
======================================================================

BƯỚC 1: BẾP BÁO HẾT MÓN
┌─────────────────────────────────────────┐
│ Bếp: Set menu_item.is_available = false │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│ Trigger: trigger_menu_item_availability_change()               │
│ → Gọi mark_order_items_as_out_of_stock(menu_item_id, false)    │
└─────────────────────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│ Database: Tạo event trong order_item_out_of_stock_events        │
│ marked_out_of_stock_at = NOW()                                  │
│ remarked_available_at = NULL                                    │
│ is_reordered_after_recovery = false                             │
└─────────────────────────────────────────────────────────────────┘
            ↓
┌──────────────────────────────────────────────────┐
│ Real-time: App nhận được PostgreSQL_changes      │
│ → loadUnavailableItems() fetch event mới        │
│ → Update unavailableOrderItems state             │
│ → UI re-render, hiện "hết món"                   │
└──────────────────────────────────────────────────┘

BƯỚC 2: BẾP BÁO CÒN LẠI
┌─────────────────────────────────────────┐
│ Bếp: Set menu_item.is_available = true  │
└─────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│ Trigger: trigger_menu_item_availability_change()               │
│ → Gọi mark_order_items_as_out_of_stock(menu_item_id, true)     │
└─────────────────────────────────────────────────────────────────┘
            ↓
┌─────────────────────────────────────────────────────────────────┐
│ Database: Cập nhật event                                        │
│ remarked_available_at = NOW()                                   │
│ is_reordered_after_recovery = false (vẫn giữ false)             │
│ → Event vẫn tồn tại với cả 2 timestamps                          │
└─────────────────────────────────────────────────────────────────┘
            ↓
┌──────────────────────────────────────────────────────┐
│ Real-time: App nhận được update event               │
│ → loadUnavailableItems() fetch event đã cập nhật   │
│ → Update unavailableOrderItems state (vẫn chứa id)  │
│ → UI re-render, hiện "không khả dụng" (strikethrough)
└──────────────────────────────────────────────────────┘

BƯỚC 3: NHÂN VIÊN ADD LẠI ITEM
┌──────────────────────────────────────────────────────┐
│ Nhân viên: Add item từ menu → sendNewItemsToKitchen() │
└──────────────────────────────────────────────────────┘
            ↓
┌──────────────────────────────────────────────────────┐
│ App: Insert items vào order_items                    │
│ → Lấy danh sách unavailable items từ DB             │
│ → Check nếu menu_item_id của item vừa add là unavailable
└──────────────────────────────────────────────────────┘
            ↓
┌──────────────────────────────────────────────────────┐
│ App: Gọi markItemAsReordered(inserted_item_id)      │
│ → RPC call update event: is_reordered_after_recovery = true
└──────────────────────────────────────────────────────┘
            ↓
┌──────────────────────────────────────────────────────┐
│ Real-time: App nhận được update event               │
│ → loadUnavailableItems() fetch lại                  │
│ → unavailableOrderItems không còn id này            │
│ → UI re-render, item không còn ở "không khả dụng"   │
└──────────────────────────────────────────────────────┘

======================================================================
CÁC TRẠNG THÁI CÓ THỂ CỦA ITEM
======================================================================

1. is_available = true, VÀ không có event (hoặc event.is_reordered = true)
   → BÌNH THƯỜNG: Hiển thị ở "Món chờ gửi bếp" / "Đợt N" / "Thanh toán"
   
2. is_available = false, VÀ có event (marked_out_of_stock_at != NULL)
   → HẾT MÓN: Hiển thị ở "Món đã hết"
   
3. is_available = true, VÀ có event (remarked_available_at != NULL, is_reordered = false)
   → KHÔNG KHỂ DỤC: Hiển thị ở "Không khả dụng" (strikethrough)
   
4. is_available = true, VÀ có event (is_reordered_after_recovery = true)
   → BÌNH THƯỜNG (đã add lại): Hiển thị ở "Món chờ gửi bếp"

======================================================================
TESTS / QC
======================================================================

Test case 1: Hết → Còn → Add lại
1. Order có item A (available = true)
2. Bếp set A.available = false
   ✓ Item A hiển thị ở "Hết món"
3. Bếp set A.available = true
   ✓ Item A hiển thị ở "Không khả dụng" (strikethrough)
4. Nhân viên add A từ menu
   ✓ Item A mới hiển thị ở "Chờ gửi bếp"
   ✓ Item A cũ không còn ở "Không khả dụng"

Test case 2: Hết → Còn → Đợi lâu (không add)
1. Order có item B
2. Bếp set B.available = false → hiển thị "Hết"
3. Bếp set B.available = true → hiển thị "Không khả dụng"
4. Đợi lâu, kh không add B
   ✓ Item B vẫn ở "Không khả dụng"
   ✓ Tính toán doanh thu không tính B

Test case 3: Offline khi order item
1. Nhân viên order item C (offline)
2. Kết nối lại mạng
   ✓ Item C được insert vào order
   ✓ Nếu C là unavailable, được mark as reordered
   ✓ UI update đúng

======================================================================
