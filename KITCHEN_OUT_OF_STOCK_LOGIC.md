# üçΩÔ∏è Logic Nghi·ªáp V·ª•: B√°o H·∫øt M√≥n ·∫¢nh H∆∞·ªüng ƒê·∫øn B·∫øp

## üìñ Ph√¢n t√≠ch Logic Nghi·ªáp V·ª•

### **T√¨nh hu·ªëng:**
1. **Staff** ƒë√£ order M√≥n A cho nhi·ªÅu b√†n ‚Üí G·ª≠i b·∫øp (status = `waiting`)
2. **B·∫øp** ƒëang ch·∫ø bi·∫øn m·ªôt s·ªë m√≥n A (status = `in_progress`)
3. **B·∫øp** v√†o `ItemAvailabilityScreen` ‚Üí B·∫•m **"B√°o h·∫øt"** cho M√≥n A
4. **4 m√†n h√¨nh b·∫øp c·∫ßn c·∫≠p nh·∫≠t:**
   - `KitchenDisplayScreen` - Danh s√°ch order t·ªïng h·ª£p
   - `KitchenDetailScreen` - Chi ti·∫øt order c·ªßa 1 b√†n
   - `KitchenSummaryScreen` - T·ªïng h·ª£p m√≥n theo t√™n
   - `KitchenSummaryDetailScreen` - Chi ti·∫øt m√≥n theo b√†n

---

## ‚úÖ Logic Nghi·ªáp V·ª• H·ª£p L√Ω

### **Quy t·∫Øc x·ª≠ l√Ω khi m√≥n h·∫øt (`is_available = false`):**

| Tr·∫°ng th√°i m√≥n | Khi m√≥n H·∫æT | L√Ω do |
|---------------|------------|-------|
| **Ch·ªù b·∫øp** (`waiting`) | ‚ùå **·∫®n ho√†n to√†n** | Kh√¥ng th·ªÉ ch·∫ø bi·∫øn ƒë∆∞·ª£c ‚Üí Kh√¥ng hi·ªÉn th·ªã |
| **ƒêang l√†m** (`in_progress`) | ‚ö†Ô∏è **Hi·ªÉn th·ªã + Badge c·∫£nh b√°o** | ƒêang l√†m r·ªìi ‚Üí Ph·∫£i l√†m ti·∫øp |
| **Ho√†n th√†nh** (`completed`) | ‚úÖ **Hi·ªÉn th·ªã b√¨nh th∆∞·ªùng** | ƒê√£ xong ‚Üí Kh√¥ng ·∫£nh h∆∞·ªüng |
| **ƒê√£ tr·∫£** (`served`) | ‚úÖ **·∫®n (logic c≈©)** | ƒê√£ ph·ª•c v·ª• xong |

### **H√†nh vi mong mu·ªën:**

```
B·∫øp b√°o h·∫øt M√≥n A:
‚îú‚îÄ Order #1: B√†n 01 (2x M√≥n A - waiting) ‚Üí ‚ùå Bi·∫øn m·∫•t kh·ªèi danh s√°ch
‚îú‚îÄ Order #2: B√†n 02 (3x M√≥n A - in_progress) ‚Üí ‚ö†Ô∏è Hi·ªÉn th·ªã badge "H·∫øt m√≥n"
‚îú‚îÄ Order #3: B√†n 03 (1x M√≥n A - completed) ‚Üí ‚úÖ Hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
‚îî‚îÄ Order #4: B√†n 04 (2x M√≥n A - waiting, 1x M√≥n B - in_progress) 
               ‚Üí M√≥n A bi·∫øn m·∫•t, gi·ªØ l·∫°i M√≥n B
```

---

## üîß C√°c Thay ƒê·ªïi ƒê√£ Th·ª±c Hi·ªán

### **1. KitchenDisplayScreen.tsx**

#### **A. C·∫≠p nh·∫≠t Interface:**
```typescript
interface KitchenItem {
  id: number;
  name: string;
  quantity: number;
  note: string | null;
  status: KitchenItemStatus;
  is_available?: boolean; // ‚úÖ Th√™m m·ªõi
}
```

#### **B. C·∫≠p nh·∫≠t Query:**
```typescript
const { data, error } = await supabase
  .from('order_items')
  .select(`
    id, quantity, customizations, status, 
    menu_items ( is_available ), // ‚úÖ Th√™m is_available
    orders ( id, created_at, order_tables ( tables ( name ) ) )
  `)
  .neq('status', STATUS.SERVED);
```

#### **C. L·ªçc m√≥n h·∫øt + ch·ªù b·∫øp:**
```typescript
// Logic: N·∫øu m√≥n h·∫øt V√Ä ƒëang ch·ªù ‚Üí B·ªè qua
const isAvailable = item.menu_items?.is_available ?? true;
if (!isAvailable && item.status === STATUS.PENDING) {
  return acc; // Kh√¥ng th√™m m√≥n n√†y v√†o danh s√°ch
}

acc[orderId].items.push({
  ...item,
  is_available: isAvailable, // ‚úÖ L∆∞u tr·∫°ng th√°i
});
```

#### **D. ·∫®n order kh√¥ng c√≤n m√≥n:**
```typescript
// L·ªçc b·ªè order kh√¥ng c√≤n item n√†o (v√¨ t·∫•t c·∫£ m√≥n h·∫øt)
const finalOrders = Object.values(groupedOrders)
  .filter(order => order.items.length > 0); // ‚úÖ Ch·ªâ gi·ªØ order c√≥ m√≥n
```

#### **E. Realtime Listener:**
```typescript
// L·∫Øng nghe thay ƒë·ªïi menu_items
const menuItemsChannel = supabase
  .channel('public:menu_items:kitchen_display')
  .on('postgres_changes', { 
    event: 'UPDATE', 
    schema: 'public', 
    table: 'menu_items' 
  }, () => {
    console.log('[KitchenDisplay] M√≥n ƒÉn thay ƒë·ªïi tr·∫°ng th√°i');
    fetchKitchenOrders(); // ‚úÖ Refresh ngay l·∫≠p t·ª©c
  })
  .subscribe();
```

---

### **2. KitchenDetailScreen.tsx**

#### **A. C·∫≠p nh·∫≠t Interface:**
```typescript
interface KitchenDetailItem {
  id: number;
  name: string;
  quantity: number;
  note: string | null;
  status: KitchenItemStatus;
  customizations: any;
  is_available?: boolean; // ‚úÖ Th√™m m·ªõi
}
```

#### **B. C·∫≠p nh·∫≠t Query + Filter:**
```typescript
const { data, error } = await supabase
  .from('order_items')
  .select('id, quantity, customizations, status, menu_items ( is_available )')
  .eq('order_id', orderId)
  .neq('status', STATUS.SERVED);

// L·ªçc b·ªè m√≥n h·∫øt + ch·ªù b·∫øp
const mappedItems = data
  .map((item: any) => ({
    ...item,
    name: item.customizations.name || 'M√≥n kh√¥ng t√™n',
    is_available: item.menu_items?.is_available ?? true,
  }))
  .filter((item: any) => {
    // N·∫øu m√≥n h·∫øt V√Ä ƒëang ch·ªù ‚Üí B·ªè qua
    if (!item.is_available && item.status === STATUS.PENDING) {
      return false;
    }
    return true;
  });
```

#### **C. Hi·ªÉn th·ªã Badge "H·∫øt m√≥n":**
```typescript
const renderFooterContent = () => {
  const isOutOfStock = item.is_available === false;
  
  return (
    <View style={styles.footerActionsContainer}>
      {/* Badge c·∫£nh b√°o cho m√≥n ƒëang l√†m */}
      {isOutOfStock && status === STATUS.IN_PROGRESS && (
        <View style={styles.outOfStockBadge}>
          <Ionicons name="alert-circle" size={16} color="#DC2626" />
          <Text style={styles.outOfStockText}>H·∫øt m√≥n</Text>
        </View>
      )}
      
      {/* N√∫t Ch·∫ø bi·∫øn (ch·ªâ hi·ªÉn th·ªã n·∫øu c√≤n h√†ng) */}
      {status === STATUS.PENDING && (
        <TouchableOpacity style={styles.processButton} onPress={...}>
          <Text>Ch·∫ø bi·∫øn</Text>
        </TouchableOpacity>
      )}
      
      {/* N√∫t Xong */}
      {status === STATUS.IN_PROGRESS && (
        <TouchableOpacity style={styles.completeButton} onPress={...}>
          <Text>Xong</Text>
        </TouchableOpacity>
      )}
    </View>
  );
};
```

#### **D. Style cho Badge:**
```typescript
outOfStockBadge: {
  flexDirection: 'row',
  alignItems: 'center',
  backgroundColor: '#FEF2F2',
  paddingHorizontal: 10,
  paddingVertical: 6,
  borderRadius: 8,
  gap: 4,
  marginRight: 8,
},
outOfStockText: {
  color: '#DC2626',
  fontSize: 12,
  fontWeight: '600',
},
```

#### **E. Realtime Listener:**
```typescript
const menuItemsChannel = supabase
  .channel('public:menu_items:kitchen_detail')
  .on('postgres_changes', { 
    event: 'UPDATE', 
    schema: 'public', 
    table: 'menu_items' 
  }, () => {
    fetchOrderDetails(); // ‚úÖ Refresh
  })
  .subscribe();
```

---

### **3. KitchenSummaryScreen.tsx**

#### **A. C·∫≠p nh·∫≠t Query:**
```typescript
const { data, error } = await supabase
  .from('order_items')
  .select(`
    quantity, customizations, status, created_at, 
    menu_items ( is_available ), // ‚úÖ Th√™m is_available
    orders(order_tables(tables(name)))
  `)
  .in('status', STATUS_TO_AGGREGATE);
```

#### **B. L·ªçc m√≥n h·∫øt + ch·ªù:**
```typescript
const itemMap = data.reduce((acc, item) => {
  const itemName = item.customizations.name;
  
  // B·ªè qua m√≥n h·∫øt h√†ng + ƒëang ch·ªù
  const menuItems = item.menu_items as any;
  const isAvailable = menuItems?.is_available ?? true;
  if (!isAvailable && item.status === 'waiting') {
    return acc; // Kh√¥ng t√≠nh m√≥n n√†y
  }
  
  // T√≠nh t·ªïng s·ªë l∆∞·ª£ng...
  acc[itemName].total_quantity += item.quantity;
  ...
}, {});
```

#### **C. Realtime Listener:**
```typescript
const menuItemsChannel = supabase
  .channel('public:menu_items:kitchen_summary')
  .on('postgres_changes', { 
    event: 'UPDATE', 
    schema: 'public', 
    table: 'menu_items' 
  }, () => {
    fetchSummaryData(); // ‚úÖ Refresh
  })
  .subscribe();
```

---

### **4. KitchenSummaryDetailScreen.tsx**

#### **A. C·∫≠p nh·∫≠t Interface:**
```typescript
interface SummaryDetailItem {
  id: number;
  quantity: number;
  status: StatusType;
  customizations: any;
  table_name: string;
  is_available?: boolean; // ‚úÖ Th√™m m·ªõi
}
```

#### **B. C·∫≠p nh·∫≠t Query + Filter:**
```typescript
const { data, error } = await supabase
  .from('order_items')
  .select(`
    id, quantity, status, customizations, 
    menu_items ( is_available ), // ‚úÖ Th√™m is_available
    orders ( order_tables ( tables ( name ) ) )
  `)
  .in('status', [STATUS.PENDING, STATUS.IN_PROGRESS, STATUS.COMPLETED])
  .eq('customizations->>name', itemName);

// L·ªçc b·ªè m√≥n h·∫øt + ch·ªù
const mappedItems = data
  .map((item: any) => ({
    ...item,
    table_name: item.orders?.order_tables[0]?.tables?.name || 'Mang v·ªÅ',
    is_available: item.menu_items?.is_available ?? true,
  }))
  .filter((item: any) => {
    // N·∫øu m√≥n h·∫øt V√Ä ƒëang ch·ªù ‚Üí B·ªè qua
    if (!item.is_available && item.status === STATUS.PENDING) {
      return false;
    }
    return true;
  });
```

#### **C. Hi·ªÉn th·ªã Badge "H·∫øt m√≥n":**
```typescript
const renderFooterActions = () => {
  const isOutOfStock = item.is_available === false;
  
  return (
    <View style={styles.footerActionsContainer}>
      {isOutOfStock && status === STATUS.IN_PROGRESS && (
        <View style={styles.outOfStockBadge}>
          <Ionicons name="alert-circle" size={16} color="#DC2626" />
          <Text style={styles.outOfStockText}>H·∫øt m√≥n</Text>
        </View>
      )}
      
      {status === STATUS.PENDING && (
        <TouchableOpacity onPress={...}>Ch·∫ø bi·∫øn</TouchableOpacity>
      )}
      
      {status === STATUS.IN_PROGRESS && (
        <TouchableOpacity onPress={...}>Tr·∫£ m√≥n</TouchableOpacity>
      )}
    </View>
  );
};
```

#### **D. Realtime Listener:**
```typescript
const menuItemsChannel = supabase
  .channel('public:menu_items:kitchen_summary_detail')
  .on('postgres_changes', { 
    event: 'UPDATE', 
    schema: 'public', 
    table: 'menu_items' 
  }, () => {
    fetchDetails(); // ‚úÖ Refresh
  })
  .subscribe();
```

---

## üéØ T·ªïng K·∫øt Logic Nghi·ªáp V·ª•

### **‚úÖ Logic H·ª¢P L√ù:**

1. ‚úÖ **M√≥n ch·ªù b·∫øp + h·∫øt** ‚Üí ·∫®n ho√†n to√†n (kh√¥ng th·ªÉ l√†m)
2. ‚úÖ **M√≥n ƒëang l√†m + h·∫øt** ‚Üí Hi·ªÉn th·ªã badge c·∫£nh b√°o (ph·∫£i l√†m ti·∫øp)
3. ‚úÖ **M√≥n ho√†n th√†nh + h·∫øt** ‚Üí Hi·ªÉn th·ªã b√¨nh th∆∞·ªùng (ƒë√£ xong)
4. ‚úÖ **Order kh√¥ng c√≤n m√≥n** ‚Üí ·∫®n ho√†n to√†n (tr√°nh hi·ªÉn th·ªã order tr·ªëng)
5. ‚úÖ **Realtime update** ‚Üí T·ª± ƒë·ªông refresh khi b√°o h·∫øt/c√≤n

### **üîÑ Lu·ªìng ho·∫°t ƒë·ªông:**

```
1. B·∫øp b√°o h·∫øt M√≥n A (is_available = false)
   ‚Üì
2. Realtime trigger ‚Üí 4 m√†n h√¨nh nh·∫≠n UPDATE
   ‚Üì
3. Fetch l·∫°i data t·ª´ DB (c√≥ is_available m·ªõi)
   ‚Üì
4. Filter:
   ‚îú‚îÄ M√≥n A (waiting) ‚Üí ·∫®n
   ‚îú‚îÄ M√≥n A (in_progress) ‚Üí Hi·ªÉn th·ªã badge "H·∫øt m√≥n"
   ‚îî‚îÄ M√≥n A (completed) ‚Üí Hi·ªÉn th·ªã b√¨nh th∆∞·ªùng
   ‚Üì
5. UI t·ª± ƒë·ªông c·∫≠p nh·∫≠t ‚ö°
```

---

## üìä So s√°nh Tr∆∞·ªõc & Sau

| T√¨nh hu·ªëng | Tr∆∞·ªõc | Sau |
|-----------|-------|-----|
| M√≥n h·∫øt + ch·ªù b·∫øp | ‚ùå V·∫´n hi·ªÉn th·ªã | ‚úÖ ·∫®n ho√†n to√†n |
| M√≥n h·∫øt + ƒëang l√†m | ‚ùå Kh√¥ng bi·∫øt h·∫øt | ‚úÖ Badge "H·∫øt m√≥n" |
| Order ch·ªâ c√≥ m√≥n h·∫øt | ‚ùå Hi·ªÉn th·ªã order tr·ªëng | ‚úÖ ·∫®n order |
| Khi b√°o h·∫øt | ‚ùå C·∫ßn F5 th·ªß c√¥ng | ‚úÖ Realtime update |

---

## ‚úÖ K·∫øt lu·∫≠n

### **Logic nghi·ªáp v·ª• H·ª¢P L√ù v√¨:**
1. ‚úÖ Kh√¥ng hi·ªÉn th·ªã m√≥n kh√¥ng th·ªÉ l√†m (h·∫øt + ch·ªù)
2. ‚úÖ C·∫£nh b√°o m√≥n ƒëang l√†m nh∆∞ng h·∫øt (ƒë·ªÉ bi·∫øt kh√¥ng order th√™m)
3. ‚úÖ Kh√¥ng ·∫£nh h∆∞·ªüng m√≥n ƒë√£ ho√†n th√†nh
4. ‚úÖ Realtime update ‚Üí UX t·ªët, kh√¥ng c·∫ßn F5
5. ‚úÖ Tr√°nh hi·ªÉn th·ªã order/t·ªïng h·ª£p tr·ªëng g√¢y nh·∫ßm l·∫´n

### **C√°c m√†n h√¨nh ho·∫°t ƒë·ªông nh·∫•t qu√°n:**
- ‚úÖ **KitchenDisplayScreen** - ·∫®n order kh√¥ng c√≤n m√≥n
- ‚úÖ **KitchenDetailScreen** - ·∫®n m√≥n ch·ªù + badge m√≥n ƒëang l√†m
- ‚úÖ **KitchenSummaryScreen** - Kh√¥ng t√≠nh m√≥n h·∫øt + ch·ªù v√†o t·ªïng h·ª£p
- ‚úÖ **KitchenSummaryDetailScreen** - ·∫®n m√≥n ch·ªù + badge m√≥n ƒëang l√†m

üéâ **Ho√†n th√†nh!** Logic ƒë√£ h·ª£p l√Ω v√† ƒë·ªìng b·ªô gi·ªØa t·∫•t c·∫£ c√°c m√†n h√¨nh B·∫øp.
